version: '3.3'

services:
  web:
    image: healthsites/web
    command: ./utils/wait-for.sh db:5432 -- uwsgi --http-socket :8000 --workers 1 --static-map /static=./static/ --offload-threads --master --module core.wsgi:application
    environment:
      - DJANGO_SETTINGS_MODULE=core.settings.prod
      - SECRET_FILE=hs-secret.py
    secrets:
      - hs-secret.py
    depends_on:
      - db
      - rabbitmq
    networks:
      - hs-stag-infra
    volumes:
      - ./media:/data/media
      - ./cache:/data/cache
    deploy:
      replicas: 2


  worker:
    image: healthsites/web
    command: ./utils/wait-for.sh db:5432 -- celery worker -A localities -l info -c 1
    environment:
      - DJANGO_SETTINGS_MODULE=core.settings.prod
      - SECRET_FILE=hs-secret.py
    secrets:
      - hs-secret.py
    depends_on:
      - db
      - rabbitmq
    networks:
      - hs-stag-infra
    volumes:
      - ./media:/data/media
      - ./cache:/data/cache
    deploy:
      replicas: 1


  scheduler:
    image: healthsites/web
    command: celery beat -A localities -l info
    environment:
      - DJANGO_SETTINGS_MODULE=core.settings.prod
      - SECRET_FILE=hs-secret.py
    secrets:
      - hs-secret.py
    depends_on:
      - db
      - rabbitmq
    networks:
      - hs-stag-infra
    deploy:
      replicas: 1


  smtp:
    image: catatnight/postfix
    environment:
      - maildomain=healthsites.io
      - smtp_user=noreply:docker
    networks:
      - hs-stag-infra
    deploy:
      replicas: 1

  rabbitmq:
    image: rabbitmq
    environment:
      - RABBITMQ_NODENAME=rabbitmq
    networks:
      - hs-stag-infra
    deploy:
      replicas: 1


  db:
    image: mdillon/postgis:9.4-alpine
    environment:
      - POSTGRES_USER=docker
      - POSTGERS_PASSWORD=docker
      - POSTGRES_DB=base_db
    networks:
      - hs-stag-infra
    volumes:
      - ./pg_data:/var/lib/postgresql/data
    deploy:
      replicas: 1


  nginx:
    image: nginx:alpine
    deploy:
      replicas: 1
    ports:
      - "80"
    networks:
      - hs-stag-infra
    volumes:
      - ./media:/data/media
      - ./hs-nginx:/etc/nginx/conf.d

secrets:
  hs-secret.py:
    external: true


networks:
  hs-stag-infra:
    external: true
